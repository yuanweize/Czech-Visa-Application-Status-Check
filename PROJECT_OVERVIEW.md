# Project Overview / 项目概览

Czech Visa Application Status Check is a compact CLI to generate visa application query codes and bulk-check application status on the Czech Immigration Office website.
本项目是一个用于生成签证申请查询码并在捷克移民局网站批量查询申请状态的小型命令行工具。

Refactor 2025: Playwright-only, async workers, simplified CLI. Legacy Selenium/agent/backends removed.
2025 重构：仅 Playwright、异步并发、精简 CLI；已移除 Selenium/Agent/多后端。

## Design goals / 设计目标
- Reliable long-running batches with per-row CSV flush and retries/backoff.
- 支持长期批量运行，通过逐行写回 CSV 与重试/退避实现鲁棒性。
- Simple module-based extensibility to add more countries.
- 基于模块的可扩展性，便于添加更多国家支持。

## Module API / 模块 API
- Country module exposes `update_csv_with_status(csv_path: str, headless=True, workers=1, retries=3, log_dir='logs', **_) -> None`.
- 国家模块导出 `update_csv_with_status(csv_path: str, headless=True, workers=1, retries=3, log_dir='logs', **_) -> None`。
- Behavior：read CSV → query via Playwright → write normalized result per row → append failures to `logs/fails/YYYY-MM-DD_fails.csv`.
- 行为：读取 CSV → 使用 Playwright 查询 → 逐行写回标准化结果 → 失败行追加到 `logs/fails/YYYY-MM-DD_fails.csv`。
- Register in `visa_status.py` under `QUERY_MODULES`.
- 在 `visa_status.py` 的 `QUERY_MODULES` 中注册。

## Project layout / 项目结构
```
visa_status.py                # CLI entrypoint/dispatcher (aliases & short flags supported)
monitor/                      # Monitoring and user management modules
  ├─ scheduler.py             # Main monitoring scheduler with integrated HTTP server
  ├─ api_server.py            # User management API module (imported by scheduler)
  ├─ config.py                # Configuration management
  └─ notify.py                # Email notification system
query_modules/
  └─ cz.py                    # Czech module (Playwright-only, async workers)
site/                         # Static website files (HTML, CSS, JS) for user interface
  ├─ index.html               # Main website with monitoring dashboard
  ├─ assets/                  # CSS and JavaScript files
  └─ status.json              # Real-time status data (generated by monitor)
tools/
  └─ generate_codes.py        # code generator
logs/                         # runtime logs; fails under logs/fails/DATE_fails.csv
requirements.txt              # playwright (+ optional matplotlib + watchdog for hot reloading)
README.md
PROJECT_OVERVIEW.md
```

## Monitor (scheduler + Email) / 监控（调度器 + 邮件）
- Email-only via SMTP (Telegram removed). 可为每个查询码配置 1 个或多个收件邮箱。
- Writes `SITE_DIR/status.json`（仅字符串状态）与静态站点目录；当 `SERVE=true` 时内置 HTTP 将以 `SITE_DIR` 为根在 `SITE_PORT` 端口提供访问。
- Sequential for stability; per-cycle browser lifecycle: create Chromium only during a cycle and close it afterward to minimize idle CPU. 复用 cz 查询逻辑，失败时软恢复并必要时重建页面/上下文。
- Email subject: `[<Status>] <Code> - CZ Visa Status`; HTML body shows old→new when changed.

**Hot reloading / .env 热更新 (Enhanced)**

Advanced hot reloading system with differential updates and robustness features:

- **Differential Processing**: Only handles added/removed/modified codes, leaves unchanged codes untouched
- **Race Condition Protection**: Retry mechanism with delays handles temporary file states during editing
- **SMTP Connection Pooling**: Reuses connections with rate limiting to prevent "too many AUTH" server bans
- **Automatic Status Updates**: Real-time updates to status.json when notification channels change
- **Empty Channel Support**: Set channel to empty string to disable notifications for specific codes
- **Enhanced Logging**: Detailed cycle logging with automatic 2MB log rotation
- **Robust Error Handling**: Graceful recovery from file I/O errors and JSON parsing issues

监控器支持高级 `.env` 文件热更新，包含差异化处理和稳健性功能：

- **差异化处理**：仅处理新增/删除/修改的代码，保持未变更代码不变
- **防竞态条件**：重试机制处理编辑期间的临时文件状态
- **SMTP 连接池**：复用连接并限制频率，防止服务器禁用
- **自动状态更新**：通知渠道变更时实时更新 status.json
- **增强日志**：详细的周期日志，自动 2MB 轮换

---

## User Management System / 用户管理系统

**Architecture / 架构:**
- **Modular Integration**: User management functionality is implemented in `monitor/api_server.py` and integrated into the main scheduler
- **模块化集成**：用户管理功能在 `monitor/api_server.py` 中实现，集成到主调度器中
- **Single Server Design**: When `SERVE=true`, the scheduler serves both static files and API endpoints
- **单服务器设计**：当 `SERVE=true` 时，调度器同时提供静态文件和API端点服务

**Features / 功能:**
- **Email Verification**: Secure 10-minute verification links for code additions
- **邮件验证**：代码添加的10分钟安全验证链接
- **Simple Captcha**: Basic math questions to prevent automated abuse
- **简单验证码**：基础数学题防止自动化滥用
- **Code Management**: Users can view and delete their own codes via web interface
- **代码管理**：用户可通过Web界面查看和删除自己的代码
- **Data Integration**: User-added codes are automatically integrated into monitoring system
- **数据集成**：用户添加的代码自动集成到监控系统中

**Configuration Control / 配置控制:**
- `SERVE=true`: Enables web interface with user management (port 8000)
- `SERVE=true`：启用包含用户管理的Web界面（端口8000）
- `SERVE=false`: Pure monitoring mode without web interface
- `SERVE=false`：纯监控模式，无Web界面

---

## Monitor service
- HTTP server: `SERVE=true` + `SITE_PORT` → serves `SITE_DIR` as doc root.
- Systemd (Debian):
  - Installs a unit to /etc/systemd/system/cz-visa-monitor.service
  - ExecStart: python visa_status.py monitor -e /path/to/.env
  - Restart=always; requires sudo for install/start/stop.
  - Prefers uv virtualenv (`.venv/bin/python`) if present; override with `--python-exe` at install time.
- CLI helpers: `--install/--uninstall/--start/--stop/--reload/--restart/--status`（`--status` 使用 `--no-pager`）。

## Technical notes / 技术说明
1) CSV-first design / CSV 优先
- State is kept in CSV and updated per-row; supports resume/auditing/manual fixes.
- 状态保存在 CSV 并逐行更新；支持断点续跑、审计与人工修复。

2) Playwright workers / Playwright 并发
- One browser; N pages; headless by default; `--headless False` shows UI.
- 单浏览器；N 个页面；默认无头；`--headless False` 显示界面。

3) Overlay & result extraction / 覆盖层与结果提取
- Click/hide/remove overlays; multi-selector polling; JS fallbacks.
- 点击/隐藏/移除覆盖层；多选择器轮询；JS 回退。

4) Logging & summary / 日志与总结
- Enhanced logging with automatic 2MB rotation (preserves last 1000 lines)
- Detailed cycle tracking: configuration reloads, code processing, email notifications
- Runtime logs under `logs/`; failures archived with `连续失败次数/Consecutive_Fail_Count`
- 增强日志系统：自动 2MB 轮换（保留最后 1000 行），详细周期跟踪：配置重载、代码处理、邮件通知
- 运行时日志位于 `logs/`；失败行归档并带有连续失败次数

## CLI notes / CLI 说明
- Aliases: `generate-codes` = `gen`/`gc`, `report` = `rep`/`r`, `cz` = `c`.
- 别名：`generate-codes` = `gen`/`gc`，`report` = `rep`/`r`，`cz` = `c`。
- Global flags: `-r/--retries`, `-l/--log-dir`.
- 全局参数：`-r/--retries`、`-l/--log-dir`。

## Reporting / 报告
- `python visa_status.py report [-i CSV] [--charts] [-o PATH]` → Markdown with optional charts.
- 通过 `python visa_status.py report [-i CSV] [--charts] [-o PATH]` 生成 Markdown（可选图表）。

## Quick start (uv) / 快速开始（uv）
See README Quick start (uv) for step-by-step setup.
详细步骤见 README 的“Quick start (uv)”。

## Version control hygiene / 版本控制规范
Ignored by default (.gitignore) / 默认忽略：
- Runtime artifacts: `logs/`, `reports/`, `monitor_site/`, `.output/`。
- Credentials and secrets: `.env`, `.env.*`, `*.secrets`, `credentials.json`。

CSV files are tracked as data. 如需忽略本地测试 CSV，可添加更窄规则（如 `*.local.csv`）。
